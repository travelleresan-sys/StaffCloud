{% extends "base.html" %}

{% block title %}給与計算結果 - StaffCloud{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- ヘッダー -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="bi bi-calculator me-2"></i>給与計算結果
                </h1>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('working_time_input') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>労働時間入力
                    </a>
                    <a href="{{ url_for('accounting_dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-house me-1"></i>ダッシュボード
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- フィルター -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="employee_id" class="form-label">従業員</label>
                            <select class="form-select" id="employee_id" name="employee_id">
                                <option value="">全従業員</option>
                                {% for employee in employees %}
                                <option value="{{ employee.id }}" {{ 'selected' if request.args.get('employee_id') == employee.id|string else '' }}>
                                    {{ employee.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="year" class="form-label">年</label>
                            <select class="form-select" id="year" name="year">
                                {% for year in years %}
                                <option value="{{ year }}" {{ 'selected' if request.args.get('year') == year|string else '' }}>{{ year }}年</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="month" class="form-label">月</label>
                            <select class="form-select" id="month" name="month">
                                {% for month in range(1, 13) %}
                                <option value="{{ month }}" {{ 'selected' if request.args.get('month') == month|string else '' }}>{{ month }}月</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-search me-1"></i>表示
                            </button>
                            <a href="{{ url_for('payroll_results') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-1"></i>リセット
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 給与計算結果一覧 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table me-2"></i>給与計算結果一覧
                    </h5>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkIssueModal">
                        <i class="bi bi-file-earmark-pdf me-1"></i>一括給与明細発行
                    </button>
                </div>
                <div class="card-body">
                    {% if payroll_results %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>従業員名</th>
                                    <th>対象年月</th>
                                    <th>給与形態</th>
                                    <th>基本給</th>
                                    <th>法定内労働</th>
                                    <th>法定外</th>
                                    <th>休日労働</th>
                                    <th>深夜労働</th>
                                    <th>休業補償</th>
                                    <th>欠勤控除</th>
                                    <th class="text-primary"><strong>総支給額</strong></th>
                                    <th>計算日時</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in payroll_results %}
                                <tr>
                                    <td><strong>{{ result.employee.name }}</strong></td>
                                    <td>{{ result.year }}年{{ result.month }}月</td>
                                    <td>
                                        {% if result.employee.wage_type == 'monthly' %}月給
                                        {% elif result.employee.wage_type == 'daily' %}日給
                                        {% elif result.employee.wage_type == 'hourly' %}時給
                                        {% else %}未設定{% endif %}
                                    </td>
                                    <td class="text-end">{{ "{:,}".format(result.base_salary) }}円</td>
                                    <td class="text-end">{{ "{:,}".format(result.base_salary or 0) }}円</td>
                                    <td class="text-end text-warning">{{ "{:,}".format(result.overtime_allowance or 0) }}円</td>
                                    <td class="text-end text-info">{{ "{:,}".format(result.holiday_allowance or 0) }}円</td>
                                    <td class="text-end text-secondary">{{ "{:,}".format(result.night_allowance or 0) }}円</td>
                                    <td class="text-end text-success">{{ "{:,}".format(0) }}円</td>
                                    <td class="text-end text-danger">-{{ "{:,}".format(0) }}円</td>
                                    <td class="text-end text-primary"><strong>{{ "{:,}".format(result.gross_salary) }}円</strong></td>
                                    <td class="text-nowrap">{{ result.calculated_at.strftime('%m/%d %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-calculator display-1 text-muted"></i>
                        <p class="lead text-muted mt-3">給与計算結果がありません。</p>
                        <p class="text-muted">労働時間を入力して給与計算を実行してください。</p>
                        <a href="{{ url_for('working_time_input') }}" class="btn btn-primary">
                            <i class="bi bi-clock-history me-1"></i>労働時間入力
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細表示（選択された従業員がいる場合） -->
    {% if selected_result %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-badge me-2"></i>{{ selected_result.employee.name }} - {{ selected_result.year }}年{{ selected_result.month }}月 詳細
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- 労働時間詳細 -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">労働時間内訳</h6>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td>法定内労働時間</td>
                                    <td class="text-end">{{ "%.1f"|format(selected_result.regular_working_minutes / 60) }}時間</td>
                                </tr>
                                <tr>
                                    <td>法定内残業時間</td>
                                    <td class="text-end">{{ "%.1f"|format(selected_result.legal_overtime_minutes / 60) }}時間</td>
                                </tr>
                                <tr>
                                    <td>法定外残業時間</td>
                                    <td class="text-end text-warning">{{ "%.1f"|format(selected_result.overtime_minutes / 60) }}時間</td>
                                </tr>
                                <tr>
                                    <td>休日労働時間</td>
                                    <td class="text-end text-info">{{ "%.1f"|format((selected_result.legal_holiday_minutes + selected_result.holiday_minutes) / 60) }}時間</td>
                                </tr>
                                <tr>
                                    <td>深夜労働時間</td>
                                    <td class="text-end text-secondary">{{ "%.1f"|format(selected_result.night_working_minutes / 60) }}時間</td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>総労働時間</strong></td>
                                    <td class="text-end"><strong>{{ "%.1f"|format(((selected_result.regular_working_minutes or 0) + (selected_result.overtime_minutes or 0)) / 60) }}時間</strong></td>
                                </tr>
                            </table>
                        </div>

                        <!-- 休暇日数詳細 -->
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">休暇・欠勤日数</h6>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td>有給休暇</td>
                                    <td class="text-end">{{ selected_result.paid_leave_days }}日</td>
                                </tr>
                                <tr>
                                    <td>特別休暇</td>
                                    <td class="text-end">{{ selected_result.special_leave_days }}日</td>
                                </tr>
                                <tr>
                                    <td>欠勤</td>
                                    <td class="text-end text-danger">{{ selected_result.absence_days }}日</td>
                                </tr>
                                <tr>
                                    <td>会社都合休業</td>
                                    <td class="text-end text-warning">{{ selected_result.company_closure_days }}日</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- 一括給与明細発行モーダル -->
<div class="modal fade" id="bulkIssueModal" tabindex="-1" aria-labelledby="bulkIssueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkIssueModalLabel">
                    <i class="bi bi-file-earmark-pdf me-2"></i>一括給与明細発行
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('bulk_issue_payroll_slips') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bulk_year" class="form-label">対象年</label>
                        <select class="form-select" id="bulk_year" name="year" required>
                            <option value="">年を選択</option>
                            {% for year in years %}
                            <option value="{{ year }}">{{ year }}年</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk_month" class="form-label">対象月</label>
                        <select class="form-select" id="bulk_month" name="month" required>
                            <option value="">月を選択</option>
                            {% for month in range(1, 13) %}
                            <option value="{{ month }}">{{ month }}月</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">対象従業員</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="employee_scope" id="all_employees" value="all" checked>
                            <label class="form-check-label" for="all_employees">
                                全従業員（保存済み明細データがある従業員）
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="employee_scope" id="selected_employees" value="selected">
                            <label class="form-check-label" for="selected_employees">
                                特定の従業員を選択
                            </label>
                        </div>
                        <div id="employee_selection" class="mt-3" style="display: none;">
                            <select class="form-select" name="employee_ids" multiple size="10">
                                {% for employee in employees %}
                                <option value="{{ employee.id }}">{{ employee.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ctrlキーを押しながら複数選択可能</small>
                        </div>
                    </div>
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        選択された年月の保存済み給与明細データをPDFとして一括生成します。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-download me-1"></i>PDFダウンロード
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 従業員選択の表示制御
    document.addEventListener('DOMContentLoaded', function() {
        const allEmployees = document.getElementById('all_employees');
        const selectedEmployees = document.getElementById('selected_employees');
        const employeeSelection = document.getElementById('employee_selection');
        
        allEmployees.addEventListener('change', function() {
            if (this.checked) {
                employeeSelection.style.display = 'none';
            }
        });
        
        selectedEmployees.addEventListener('change', function() {
            if (this.checked) {
                employeeSelection.style.display = 'block';
            }
        });
    });
</script>
{% endblock %}