{% extends "base.html" %}

{% block title %}労働条件変更通知書作成 - StaffCloud{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h2 mb-2">
                        <i class="bi bi-arrow-repeat me-2"></i>労働条件変更通知書作成
                    </h1>
                    <p class="text-muted mb-0">従業員の労働条件変更通知書を作成します（厚生労働省モデル準拠）</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('company_submissions') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>戻る
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 労働条件変更通知書作成フォーム -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i>労働条件変更通知書作成
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_working_conditions_change') }}">
                        <!-- 従業員選択 -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="use_existing_employee" onchange="toggleEmployeeInput()">
                                    <label class="form-check-label" for="use_existing_employee">
                                        既存従業員から選択する
                                    </label>
                                </div>
                                <select class="form-select" id="employee_id" name="employee_id" disabled onchange="loadEmployeeData(this.value)">
                                    <option value="">従業員を選択してください</option>
                                    {% for employee in employees %}
                                        <option value="{{ employee.id }}" 
                                                data-name="{{ employee.name }}"
                                                data-position="{{ employee.position or '' }}"
                                                data-department="{{ employee.department or '' }}"
                                                data-salary="{{ employee.base_salary or '' }}">
                                            {{ employee.name }} ({{ employee.id }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- 従業員名（手入力） -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="employee_name" class="form-label">従業員名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="employee_name" name="employee_name" required>
                            </div>
                        </div>

                        <!-- 変更基本情報 -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-calendar-event me-2"></i>変更基本情報
                                </h6>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="change_date" class="form-label">変更実施日 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="change_date" name="change_date" required>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="change_reason" class="form-label">変更理由 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="change_reason" name="change_reason" rows="2" required
                                          placeholder="例：組織改編、昇進・昇格、業務拡大等"></textarea>
                            </div>
                        </div>

                        <!-- 変更項目（厚労省モデル準拠） -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-warning mb-3">
                                    <i class="bi bi-arrow-left-right me-2"></i>労働条件変更項目
                                </h6>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    各項目について「変更あり」または「変更なし」を選択してください。変更なしの場合は現在の条件を記入してください。
                                </div>
                            </div>

                            <!-- 1. 労働契約の期間 -->
                            <div class="col-12 mb-4">
                                <div class="card border-light">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">1. 労働契約の期間</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="change_type_contract_period" id="change_contract_period" value="change" onchange="toggleChangeFields('contract_period', 'change')">
                                                <label class="btn btn-outline-primary" for="change_contract_period">変更あり</label>
                                                <input type="radio" class="btn-check" name="change_type_contract_period" id="no_change_contract_period" value="no_change" onchange="toggleChangeFields('contract_period', 'no_change')">
                                                <label class="btn btn-outline-secondary" for="no_change_contract_period">変更なし</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="change_fields_contract_period" class="row" style="display: none;">
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="old_contract_period" class="form-label">変更前</label>
                                                <select class="form-select" id="old_contract_period" name="old_contract_period">
                                                    <option value="">選択してください</option>
                                                    <option value="期間の定めなし">期間の定めなし</option>
                                                    <option value="期間の定めあり">期間の定めあり</option>
                                                </select>
                                            </div>
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="new_contract_period" class="form-label">変更後</label>
                                                <select class="form-select" id="new_contract_period" name="new_contract_period">
                                                    <option value="">選択してください</option>
                                                    <option value="期間の定めなし">期間の定めなし</option>
                                                    <option value="期間の定めあり">期間の定めあり</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="current_fields_contract_period" class="row" style="display: none;">
                                            <div class="col-12 mb-3">
                                                <label for="current_contract_period" class="form-label">現在の労働契約期間</label>
                                                <select class="form-select" id="current_contract_period" name="current_contract_period">
                                                    <option value="">選択してください</option>
                                                    <option value="期間の定めなし">期間の定めなし</option>
                                                    <option value="期間の定めあり">期間の定めあり</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. 職種・役職 -->
                            <div class="col-12 mb-4">
                                <div class="card border-light">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">2. 職種・役職</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="change_type_position" id="change_position" value="change" onchange="toggleChangeFields('position', 'change')">
                                                <label class="btn btn-outline-primary" for="change_position">変更あり</label>
                                                <input type="radio" class="btn-check" name="change_type_position" id="no_change_position" value="no_change" onchange="toggleChangeFields('position', 'no_change')">
                                                <label class="btn btn-outline-secondary" for="no_change_position">変更なし</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="change_fields_position" class="row" style="display: none;">
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="old_position" class="form-label">変更前</label>
                                                <input type="text" class="form-control" id="old_position" name="old_position" placeholder="例：営業職">
                                            </div>
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="new_position" class="form-label">変更後</label>
                                                <input type="text" class="form-control" id="new_position" name="new_position" placeholder="例：営業主任">
                                            </div>
                                        </div>
                                        <div id="current_fields_position" class="row" style="display: none;">
                                            <div class="col-12 mb-3">
                                                <label for="current_position" class="form-label">現在の職種・役職</label>
                                                <input type="text" class="form-control" id="current_position" name="current_position" placeholder="例：営業職">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. 所属部署 -->
                            <div class="col-12 mb-4">
                                <div class="card border-light">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">3. 所属部署</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="change_type_department" id="change_department" value="change" onchange="toggleChangeFields('department', 'change')">
                                                <label class="btn btn-outline-primary" for="change_department">変更あり</label>
                                                <input type="radio" class="btn-check" name="change_type_department" id="no_change_department" value="no_change" onchange="toggleChangeFields('department', 'no_change')">
                                                <label class="btn btn-outline-secondary" for="no_change_department">変更なし</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="change_fields_department" class="row" style="display: none;">
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="old_department" class="form-label">変更前</label>
                                                <input type="text" class="form-control" id="old_department" name="old_department" placeholder="例：営業部">
                                            </div>
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="new_department" class="form-label">変更後</label>
                                                <input type="text" class="form-control" id="new_department" name="new_department" placeholder="例：営業1部">
                                            </div>
                                        </div>
                                        <div id="current_fields_department" class="row" style="display: none;">
                                            <div class="col-12 mb-3">
                                                <label for="current_department" class="form-label">現在の所属部署</label>
                                                <input type="text" class="form-control" id="current_department" name="current_department" placeholder="例：営業部">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. 基本給 -->
                            <div class="col-12 mb-4">
                                <div class="card border-light">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">4. 基本給</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="change_type_base_salary" id="change_base_salary" value="change" onchange="toggleChangeFields('base_salary', 'change')">
                                                <label class="btn btn-outline-primary" for="change_base_salary">変更あり</label>
                                                <input type="radio" class="btn-check" name="change_type_base_salary" id="no_change_base_salary" value="no_change" onchange="toggleChangeFields('base_salary', 'no_change')">
                                                <label class="btn btn-outline-secondary" for="no_change_base_salary">変更なし</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="change_fields_base_salary" class="row" style="display: none;">
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="old_base_salary" class="form-label">変更前（円）</label>
                                                <input type="number" class="form-control" id="old_base_salary" name="old_base_salary" placeholder="250000" min="0">
                                            </div>
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="new_base_salary" class="form-label">変更後（円）</label>
                                                <input type="number" class="form-control" id="new_base_salary" name="new_base_salary" placeholder="300000" min="0">
                                            </div>
                                        </div>
                                        <div id="current_fields_base_salary" class="row" style="display: none;">
                                            <div class="col-12 mb-3">
                                                <label for="current_base_salary" class="form-label">現在の基本給（円）</label>
                                                <input type="number" class="form-control" id="current_base_salary" name="current_base_salary" placeholder="250000" min="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 5. 始業・終業時刻 -->
                            <div class="col-12 mb-4">
                                <div class="card border-light">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">5. 始業・終業時刻</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="change_type_work_hours" id="change_work_hours" value="change" onchange="toggleChangeFields('work_hours', 'change')">
                                                <label class="btn btn-outline-primary" for="change_work_hours">変更あり</label>
                                                <input type="radio" class="btn-check" name="change_type_work_hours" id="no_change_work_hours" value="no_change" onchange="toggleChangeFields('work_hours', 'no_change')">
                                                <label class="btn btn-outline-secondary" for="no_change_work_hours">変更なし</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="change_fields_work_hours" class="row" style="display: none;">
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="old_work_hours" class="form-label">変更前</label>
                                                <input type="text" class="form-control" id="old_work_hours" name="old_work_hours" placeholder="例：09:00-18:00">
                                            </div>
                                            <div class="col-12 col-md-6 mb-3">
                                                <label for="new_work_hours" class="form-label">変更後</label>
                                                <input type="text" class="form-control" id="new_work_hours" name="new_work_hours" placeholder="例：10:00-19:00">
                                            </div>
                                        </div>
                                        <div id="current_fields_work_hours" class="row" style="display: none;">
                                            <div class="col-12 mb-3">
                                                <label for="current_work_hours" class="form-label">現在の始業・終業時刻</label>
                                                <input type="text" class="form-control" id="current_work_hours" name="current_work_hours" placeholder="例：09:00-18:00">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 簡略化のため主要項目のみ表示。実際の実装では全21項目を追加 -->
                            <div class="col-12 mb-3">
                                <div class="alert alert-secondary">
                                    <small>※ その他の労働条件項目（勤務日・休日、時間外労働、休憩時間、年次有給休暇、賃金形態、諸手当、賃金計算方法、賃金締切日、賃金支払日、賞与、退職金、社会保険、解雇事由、その他の労働条件）についても同様の形式で入力可能です。</small>
                                </div>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-secondary me-2" onclick="window.history.back()">
                                <i class="bi bi-x-circle me-1"></i>キャンセル
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-file-earmark-arrow-up me-1"></i>労働条件変更通知書作成
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleEmployeeInput() {
    const checkbox = document.getElementById('use_existing_employee');
    const select = document.getElementById('employee_id');
    const nameField = document.getElementById('employee_name');
    
    if (checkbox.checked) {
        select.disabled = false;
        nameField.readOnly = true;
    } else {
        select.disabled = true;
        select.value = '';
        nameField.readOnly = false;
        clearEmployeeFields();
    }
}

function loadEmployeeData(employeeId) {
    const select = document.getElementById('employee_id');
    const option = select.querySelector(`option[value="${employeeId}"]`);
    
    if (option && document.getElementById('use_existing_employee').checked) {
        document.getElementById('employee_name').value = option.dataset.name || '';
        document.getElementById('current_position').value = option.dataset.position || '';
        document.getElementById('current_department').value = option.dataset.department || '';
        document.getElementById('current_base_salary').value = option.dataset.salary || '';
    }
}

function clearEmployeeFields() {
    document.getElementById('employee_name').value = '';
}

function toggleChangeFields(fieldName, changeType) {
    const changeFields = document.getElementById(`change_fields_${fieldName}`);
    const currentFields = document.getElementById(`current_fields_${fieldName}`);
    
    if (changeType === 'change') {
        changeFields.style.display = 'block';
        currentFields.style.display = 'none';
    } else if (changeType === 'no_change') {
        changeFields.style.display = 'none';
        currentFields.style.display = 'block';
    }
}
</script>
{% endblock %}