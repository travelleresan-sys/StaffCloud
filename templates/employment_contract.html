{% extends "base.html" %}

{% block title %}雇用契約書作成 - StaffCloud{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h2 mb-2">
                        <i class="bi bi-file-text me-2"></i>雇用契約書作成
                    </h1>
                    <p class="text-muted mb-0">従業員の雇用契約書を作成・管理します</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('company_submissions') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>戻る
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 雇用契約書作成フォーム -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-plus me-2"></i>新規雇用契約書作成
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_employment_contract') }}">
                        <div class="row">
                            <!-- 従業員選択（任意） -->
                            <div class="col-12 mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="use_existing_employee" onchange="toggleEmployeeInput()">
                                    <label class="form-check-label" for="use_existing_employee">
                                        既存従業員から選択する
                                    </label>
                                </div>
                                <select class="form-select" id="employee_id" name="employee_id" disabled onchange="loadEmployeeData(this.value)">
                                    <option value="">従業員を選択してください</option>
                                    {% for employee in employees %}
                                        <option value="{{ employee.id }}" 
                                                data-name="{{ employee.name }}"
                                                data-birth-date="{{ employee.birth_date.strftime('%Y-%m-%d') if employee.birth_date else '' }}"
                                                data-address="{{ employee.address or '' }}"
                                                data-phone="{{ employee.phone_number or '' }}"
                                                data-join-date="{{ employee.join_date.strftime('%Y-%m-%d') if employee.join_date else '' }}"
                                                data-position="{{ employee.position or '' }}"
                                                data-department="{{ employee.department or '' }}">
                                            {{ employee.name }} ({{ employee.id }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- 契約タイプ -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="contract_type" class="form-label">契約タイプ <span class="text-danger">*</span></label>
                                <select class="form-select" id="contract_type" name="contract_type" required>
                                    <option value="">選択してください</option>
                                    <option value="正社員">正社員</option>
                                    <option value="契約社員">契約社員</option>
                                    <option value="パートタイム">パートタイム</option>
                                    <option value="アルバイト">アルバイト</option>
                                    <option value="派遣社員">派遣社員</option>
                                    <option value="業務委託">業務委託</option>
                                </select>
                            </div>
                        </div>

                        <!-- 従業員基本情報 -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-person me-2"></i>従業員基本情報
                                </h6>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="employee_name" class="form-label">氏名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="employee_name" name="employee_name" required>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="birth_date" class="form-label">生年月日</label>
                                <input type="date" class="form-control" id="birth_date" name="birth_date">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="address" class="form-label">住所</label>
                                <textarea class="form-control" id="address" name="address" rows="2" placeholder="例：東京都渋谷区..."></textarea>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="phone_number" class="form-label">電話番号</label>
                                <input type="tel" class="form-control" id="phone_number" name="phone_number" placeholder="090-1234-5678">
                            </div>
                        </div>

                        <!-- 労働条件 -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-success mb-3">
                                    <i class="bi bi-briefcase me-2"></i>労働条件
                                </h6>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="start_date" class="form-label">契約開始日 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="contract_period_type" class="form-label">労働契約の期間 <span class="text-danger">*</span></label>
                                <select class="form-select" id="contract_period_type" name="contract_period_type" required onchange="toggleContractPeriod()">
                                    <option value="">選択してください</option>
                                    <option value="無期契約">無期契約</option>
                                    <option value="有期契約">有期契約</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6 mb-3" id="end_date_container" style="display: none;">
                                <label for="end_date" class="form-label">契約終了日</label>
                                <input type="date" class="form-control" id="end_date" name="end_date">
                            </div>
                            <div class="col-12 mb-3" id="contract_renewal_container" style="display: none;">
                                <label for="contract_renewal" class="form-label">契約の更新</label>
                                <select class="form-select" id="contract_renewal" name="contract_renewal">
                                    <option value="自動的に更新する">自動的に更新する</option>
                                    <option value="更新する場合がある">更新する場合がある</option>
                                    <option value="契約の更新はしない">契約の更新はしない</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3" id="renewal_criteria_container" style="display: none;">
                                <label for="renewal_criteria" class="form-label">契約更新の判断基準</label>
                                <textarea class="form-control" id="renewal_criteria" name="renewal_criteria" rows="2">契約期間満了時の業務量、勤務成績・態度、能力、会社の経営状況、従事している業務の進捗状況</textarea>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="work_location" class="form-label">就業場所 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="work_location" name="work_location" required 
                                       value="{{ company_settings.address if company_settings else '' }}" placeholder="例：東京都渋谷区...">
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="work_location_change" class="form-label">就業場所の変更の有無</label>
                                <select class="form-select" id="work_location_change" name="work_location_change">
                                    <option value="なし">なし</option>
                                    <option value="あり（労働者の同意を得て決定する）">あり（労働者の同意を得て決定する）</option>
                                    <option value="あり（就業規則に定めるところによる）">あり（就業規則に定めるところによる）</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="position" class="form-label">職種・役職</label>
                                <input type="text" class="form-control" id="position" name="position" placeholder="例：営業職、事務職、技術職">
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="department" class="form-label">所属部署</label>
                                <input type="text" class="form-control" id="department" name="department" placeholder="例：営業部、総務部、開発部">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="job_description" class="form-label">従事する業務の内容 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="job_description" name="job_description" rows="3" required
                                          placeholder="例：顧客への営業活動、契約書作成、売上管理等の営業業務全般"></textarea>
                            </div>
                        </div>

                        <!-- 労働時間・休日 -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-warning mb-3">
                                    <i class="bi bi-clock me-2"></i>労働時間・休日
                                </h6>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="work_start_time" class="form-label">始業時刻 <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="work_start_time" name="work_start_time" value="09:00" required>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="work_end_time" class="form-label">終業時刻 <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="work_end_time" name="work_end_time" value="18:00" required>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="break_time" class="form-label">休憩時間（分） <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="break_time" name="break_time" value="60" min="0" required>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="scheduled_working_hours" class="form-label">所定労働時間（週）</label>
                                <input type="text" class="form-control" id="scheduled_working_hours" name="scheduled_working_hours" 
                                       value="週40時間" placeholder="例：週40時間">
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="shift_work" class="form-label">交替勤務</label>
                                <select class="form-select" id="shift_work" name="shift_work">
                                    <option value="なし">なし</option>
                                    <option value="2交替制">2交替制</option>
                                    <option value="3交替制">3交替制</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="work_days" class="form-label">勤務日</label>
                                <div class="form-check-group">
                                    <div class="row">
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="monday" name="work_days" value="月" checked>
                                                <label class="form-check-label" for="monday">月</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tuesday" name="work_days" value="火" checked>
                                                <label class="form-check-label" for="tuesday">火</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="wednesday" name="work_days" value="水" checked>
                                                <label class="form-check-label" for="wednesday">水</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="thursday" name="work_days" value="木" checked>
                                                <label class="form-check-label" for="thursday">木</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="friday" name="work_days" value="金" checked>
                                                <label class="form-check-label" for="friday">金</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="saturday" name="work_days" value="土">
                                                <label class="form-check-label" for="saturday">土</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sunday" name="work_days" value="日">
                                                <label class="form-check-label" for="sunday">日</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="holidays" class="form-label">休日</label>
                                <textarea class="form-control" id="holidays" name="holidays" rows="2" 
                                          placeholder="例：土日祝日、年末年始、夏季休暇、その他会社が指定する日">土日祝日、年末年始、夏季休暇、その他会社が指定する日</textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="overtime_work" class="form-label">所定時間外労働の有無</label>
                                <select class="form-select" id="overtime_work" name="overtime_work">
                                    <option value="なし">なし</option>
                                    <option value="あり（36協定の範囲内）">あり（36協定の範囲内）</option>
                                    <option value="あり（就業規則に定めるところによる）">あり（就業規則に定めるところによる）</option>
                                </select>
                            </div>
                        </div>

                        <!-- 賃金 -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-info mb-3">
                                    <i class="bi bi-currency-yen me-2"></i>賃金
                                </h6>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="salary_type" class="form-label">賃金形態 <span class="text-danger">*</span></label>
                                <select class="form-select" id="salary_type" name="salary_type" required>
                                    <option value="">選択してください</option>
                                    <option value="月給">月給</option>
                                    <option value="日給">日給</option>
                                    <option value="時給">時給</option>
                                    <option value="年俸">年俸</option>
                                    <option value="出来高払">出来高払</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="base_salary" class="form-label">基本給（円） <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="base_salary" name="base_salary" min="0" required>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="salary_closing_date" class="form-label">賃金締切日 <span class="text-danger">*</span></label>
                                <select class="form-select" id="salary_closing_date" name="salary_closing_date" required>
                                    <option value="">選択してください</option>
                                    <option value="月末">月末</option>
                                    <option value="25日">25日</option>
                                    <option value="20日">20日</option>
                                    <option value="15日">15日</option>
                                    <option value="10日">10日</option>
                                    <option value="5日">5日</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="payment_date" class="form-label">賃金支払日 <span class="text-danger">*</span></label>
                                <select class="form-select" id="payment_date" name="payment_date" required>
                                    <option value="">選択してください</option>
                                    <option value="翌月末">翌月末</option>
                                    <option value="翌月25日">翌月25日</option>
                                    <option value="翌月20日">翌月20日</option>
                                    <option value="翌月15日">翌月15日</option>
                                    <option value="翌月10日">翌月10日</option>
                                    <option value="翌月5日">翌月5日</option>
                                    <option value="当月末">当月末</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <label for="payment_method" class="form-label">賃金支払方法 <span class="text-danger">*</span></label>
                                <select class="form-select" id="payment_method" name="payment_method" required>
                                    <option value="">選択してください</option>
                                    <option value="銀行振込">銀行振込</option>
                                    <option value="現金支給">現金支給</option>
                                    <option value="小切手">小切手</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="wage_calculation_method" class="form-label">賃金の決定・計算方法 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="wage_calculation_method" name="wage_calculation_method" rows="2" required>基本給＋諸手当（通勤手当実費支給、時間外手当は労働基準法に定める率で支給）</textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="allowances" class="form-label">諸手当の詳細</label>
                                <textarea class="form-control" id="allowances" name="allowances" rows="2">通勤手当（賃金規定に準ずる）</textarea>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="bonus_payment" class="form-label">賞与の支給</label>
                                <select class="form-select" id="bonus_payment" name="bonus_payment" onchange="toggleBonusDetails()">
                                    <option value="なし">なし</option>
                                    <option value="あり">あり</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6 mb-3" id="bonus_details_container" style="display: none;">
                                <label for="bonus_details" class="form-label">賞与の内容</label>
                                <select class="form-select" id="bonus_details" name="bonus_details">
                                    <option value="">選択してください</option>
                                    <option value="年2回（夏季・冬季）基本給の○ヶ月分">年2回（夏季・冬季）基本給の○ヶ月分</option>
                                    <option value="業績により支給">業績により支給</option>
                                    <option value="会社の業績及び個人の成績により支給">会社の業績及び個人の成績により支給</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                        </div>

                        <!-- その他条件 -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-gear me-2"></i>その他条件
                                </h6>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="trial_period" class="form-label">試用期間</label>
                                <select class="form-select" id="trial_period" name="trial_period">
                                    <option value="">なし</option>
                                    <option value="1ヶ月">1ヶ月</option>
                                    <option value="2ヶ月">2ヶ月</option>
                                    <option value="3ヶ月">3ヶ月</option>
                                    <option value="6ヶ月">6ヶ月</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="social_insurance" class="form-label">社会保険</label>
                                <div class="form-check-group">
                                    <div class="row">
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="health_insurance" name="social_insurance" value="健康保険" checked>
                                                <label class="form-check-label" for="health_insurance">健康保険</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pension_insurance" name="social_insurance" value="厚生年金保険" checked>
                                                <label class="form-check-label" for="pension_insurance">厚生年金保険</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="employment_insurance" name="social_insurance" value="雇用保険" checked>
                                                <label class="form-check-label" for="employment_insurance">雇用保険</label>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workers_compensation" name="social_insurance" value="労災保険" checked>
                                                <label class="form-check-label" for="workers_compensation">労災保険</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="retirement_allowance" class="form-label">退職金の支給</label>
                                <select class="form-select" id="retirement_allowance" name="retirement_allowance">
                                    <option value="なし">なし</option>
                                    <option value="あり（就業規則に定めるところによる）">あり（就業規則に定めるところによる）</option>
                                    <option value="あり（退職金規程に定めるところによる）">あり（退職金規程に定めるところによる）</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <label for="retirement_age" class="form-label">定年</label>
                                <select class="form-select" id="retirement_age" name="retirement_age">
                                    <option value="なし">なし</option>
                                    <option value="満60歳">満60歳</option>
                                    <option value="満65歳">満65歳</option>
                                    <option value="満70歳">満70歳</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="termination_conditions" class="form-label">退職に関する事項 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="termination_conditions" name="termination_conditions" rows="4" required>1. 従業員が退職を希望する場合は、30日前までに書面により申し出ること
2. 会社が従業員を解雇する場合は、30日前に予告するか、30日分以上の平均賃金を支払う
3. 定年により退職する場合は、定年に達した日の属する月の末日をもって退職とする
4. その他、労働基準法及び就業規則に定めるところによる</textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="dismissal_reasons" class="form-label">解雇事由 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="dismissal_reasons" name="dismissal_reasons" rows="4" required>1. 勤務成績が著しく不良で、業務に支障を及ぼす場合
2. 正当な理由なく無断欠勤が継続し、出勤の督促に応じない場合
3. 重要な経歴を詐称して雇用された場合
4. 故意または重大な過失により会社に損害を与えた場合
5. 刑事事件に関し起訴された場合
6. その他前各号に準ずる程度のやむを得ない事由がある場合</textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="special_conditions" class="form-label">特記事項</label>
                                <textarea class="form-control" id="special_conditions" name="special_conditions" rows="3" 
                                          placeholder="その他特別な条件や注意事項があれば記載してください"></textarea>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-secondary me-2" onclick="window.history.back()">
                                <i class="bi bi-x-circle me-1"></i>キャンセル
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-file-earmark-check me-1"></i>雇用契約書作成
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleEmployeeInput() {
    const checkbox = document.getElementById('use_existing_employee');
    const select = document.getElementById('employee_id');
    const nameField = document.getElementById('employee_name');
    const birthDateField = document.getElementById('birth_date');
    const addressField = document.getElementById('address');
    const phoneField = document.getElementById('phone_number');
    
    if (checkbox.checked) {
        select.disabled = false;
        nameField.readOnly = true;
        birthDateField.readOnly = true;
        addressField.readOnly = true;
        phoneField.readOnly = true;
    } else {
        select.disabled = true;
        select.value = '';
        nameField.readOnly = false;
        birthDateField.readOnly = false;
        addressField.readOnly = false;
        phoneField.readOnly = false;
        // Clear all fields when unchecking
        clearEmployeeFields();
    }
}

function loadEmployeeData(employeeId) {
    const select = document.getElementById('employee_id');
    const option = select.querySelector(`option[value="${employeeId}"]`);
    
    if (option && document.getElementById('use_existing_employee').checked) {
        document.getElementById('employee_name').value = option.dataset.name || '';
        document.getElementById('birth_date').value = option.dataset.birthDate || '';
        document.getElementById('address').value = option.dataset.address || '';
        document.getElementById('phone_number').value = option.dataset.phone || '';
        document.getElementById('start_date').value = option.dataset.joinDate || '';
        document.getElementById('position').value = option.dataset.position || '';
        document.getElementById('department').value = option.dataset.department || '';
    }
}

function clearEmployeeFields() {
    document.getElementById('employee_name').value = '';
    document.getElementById('birth_date').value = '';
    document.getElementById('address').value = '';
    document.getElementById('phone_number').value = '';
    document.getElementById('start_date').value = '';
    document.getElementById('position').value = '';
    document.getElementById('department').value = '';
}

function toggleBonusDetails() {
    const bonusPayment = document.getElementById('bonus_payment');
    const bonusDetailsContainer = document.getElementById('bonus_details_container');
    
    if (bonusPayment.value === 'あり') {
        bonusDetailsContainer.style.display = 'block';
    } else {
        bonusDetailsContainer.style.display = 'none';
        document.getElementById('bonus_details').value = '';
    }
}

function toggleContractPeriod() {
    const contractPeriodType = document.getElementById('contract_period_type');
    const endDateContainer = document.getElementById('end_date_container');
    const contractRenewalContainer = document.getElementById('contract_renewal_container');
    const renewalCriteriaContainer = document.getElementById('renewal_criteria_container');
    
    if (contractPeriodType.value === '有期契約') {
        endDateContainer.style.display = 'block';
        contractRenewalContainer.style.display = 'block';
        renewalCriteriaContainer.style.display = 'block';
    } else {
        endDateContainer.style.display = 'none';
        contractRenewalContainer.style.display = 'none';
        renewalCriteriaContainer.style.display = 'none';
        document.getElementById('end_date').value = '';
        document.getElementById('contract_renewal').value = '';
        document.getElementById('renewal_criteria').value = '';
    }
}
</script>
{% endblock %}