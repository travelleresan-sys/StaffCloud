{% extends "base.html" %}

{% block title %}取引先管理 - StaffCloud{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- ヘッダー -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="bi bi-people me-2"></i>取引先管理
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPartnerModal">
                        <i class="bi bi-plus-circle me-1"></i>取引先追加
                    </button>
                    <a href="{{ url_for('simple_journal_entry') }}" class="btn btn-outline-info">
                        <i class="bi bi-magic me-1"></i>簡単仕訳入力
                    </a>
                    <a href="{{ url_for('accounting_dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>戻る
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 取引先一覧 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list me-2"></i>取引先一覧
                    </h5>
                </div>
                <div class="card-body">
                    {% if partners %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>コード</th>
                                    <th>取引先名</th>
                                    <th>種別</th>
                                    <th>担当者</th>
                                    <th>電話番号</th>
                                    <th>FAX番号</th>
                                    <th>メールアドレス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for partner in partners %}
                                <tr>
                                    <td>{{ partner.partner_code }}</td>
                                    <td>{{ partner.partner_name }}</td>
                                    <td>
                                        {% if partner.partner_type == '顧客' %}
                                            <span class="badge bg-success">{{ partner.partner_type }}</span>
                                        {% elif partner.partner_type == '仕入先' %}
                                            <span class="badge bg-primary">{{ partner.partner_type }}</span>
                                        {% elif partner.partner_type == '金融機関' %}
                                            <span class="badge bg-warning text-dark">{{ partner.partner_type }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ partner.partner_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ partner.contact_person or '-' }}</td>
                                    <td>{{ partner.phone or '-' }}</td>
                                    <td>{{ partner.fax or '-' }}</td>
                                    <td>{{ partner.email or '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning me-1" 
                                                onclick="editPartner({{ partner.id }}, '{{ partner.partner_code }}', '{{ partner.partner_name }}', '{{ partner.partner_type }}', '{{ partner.postal_code or '' }}', '{{ partner.address or '' }}', '{{ partner.phone or '' }}', '{{ partner.fax or '' }}', '{{ partner.email or '' }}', '{{ partner.contact_person or '' }}', '{{ partner.notes or '' }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <form method="POST" action="{{ url_for('delete_partner', partner_id=partner.id) }}" class="d-inline" 
                                              onsubmit="return confirm('取引先「{{ partner.partner_name }}」を削除しますか？')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-people display-1"></i>
                        <p class="mt-3">まだ取引先が登録されていません。</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPartnerModal">
                            <i class="bi bi-plus-circle me-1"></i>最初の取引先を追加
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 取引先新規作成モーダル -->
<div class="modal fade" id="createPartnerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">取引先新規登録</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_partner') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="create_partner_code" class="form-label">取引先コード *</label>
                            <input type="text" class="form-control" id="create_partner_code" name="partner_code" required>
                        </div>
                        <div class="col-md-6">
                            <label for="create_partner_type" class="form-label">種別 *</label>
                            <select class="form-select" id="create_partner_type" name="partner_type" required>
                                <option value="">選択してください</option>
                                <option value="顧客">顧客</option>
                                <option value="仕入先">仕入先</option>
                                <option value="金融機関">金融機関</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="create_partner_name" class="form-label">取引先名 *</label>
                            <input type="text" class="form-control" id="create_partner_name" name="partner_name" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="create_postal_code" class="form-label">郵便番号</label>
                            <input type="text" class="form-control" id="create_postal_code" name="postal_code" placeholder="123-4567">
                        </div>
                        <div class="col-md-8">
                            <label for="create_address" class="form-label">住所</label>
                            <input type="text" class="form-control" id="create_address" name="address">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="create_phone" class="form-label">電話番号</label>
                            <input type="text" class="form-control" id="create_phone" name="phone" placeholder="03-1234-5678">
                        </div>
                        <div class="col-md-4">
                            <label for="create_fax" class="form-label">FAX番号</label>
                            <input type="text" class="form-control" id="create_fax" name="fax" placeholder="03-1234-5679">
                        </div>
                        <div class="col-md-4">
                            <label for="create_email" class="form-label">メールアドレス</label>
                            <input type="email" class="form-control" id="create_email" name="email">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="create_contact_person" class="form-label">担当者名</label>
                            <input type="text" class="form-control" id="create_contact_person" name="contact_person">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="create_notes" class="form-label">備考</label>
                            <textarea class="form-control" id="create_notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-primary">登録</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 取引先編集モーダル -->
<div class="modal fade" id="editPartnerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">取引先編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editPartnerForm">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_partner_code" class="form-label">取引先コード *</label>
                            <input type="text" class="form-control" id="edit_partner_code" name="partner_code" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_partner_type" class="form-label">種別 *</label>
                            <select class="form-select" id="edit_partner_type" name="partner_type" required>
                                <option value="">選択してください</option>
                                <option value="顧客">顧客</option>
                                <option value="仕入先">仕入先</option>
                                <option value="金融機関">金融機関</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="edit_partner_name" class="form-label">取引先名 *</label>
                            <input type="text" class="form-control" id="edit_partner_name" name="partner_name" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="edit_postal_code" class="form-label">郵便番号</label>
                            <input type="text" class="form-control" id="edit_postal_code" name="postal_code" placeholder="123-4567">
                        </div>
                        <div class="col-md-8">
                            <label for="edit_address" class="form-label">住所</label>
                            <input type="text" class="form-control" id="edit_address" name="address">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="edit_phone" class="form-label">電話番号</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone" placeholder="03-1234-5678">
                        </div>
                        <div class="col-md-4">
                            <label for="edit_fax" class="form-label">FAX番号</label>
                            <input type="text" class="form-control" id="edit_fax" name="fax" placeholder="03-1234-5679">
                        </div>
                        <div class="col-md-4">
                            <label for="edit_email" class="form-label">メールアドレス</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_contact_person" class="form-label">担当者名</label>
                            <input type="text" class="form-control" id="edit_contact_person" name="contact_person">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="edit_notes" class="form-label">備考</label>
                            <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-warning">更新</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editPartner(id, code, name, type, postal, address, phone, fax, email, contact, notes) {
    // フォームアクションを設定
    document.getElementById('editPartnerForm').action = `/edit_partner/${id}`;
    
    // フォームに値を設定
    document.getElementById('edit_partner_code').value = code;
    document.getElementById('edit_partner_name').value = name;
    document.getElementById('edit_partner_type').value = type;
    document.getElementById('edit_postal_code').value = postal;
    document.getElementById('edit_address').value = address;
    document.getElementById('edit_phone').value = phone;
    document.getElementById('edit_fax').value = fax;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_contact_person').value = contact;
    document.getElementById('edit_notes').value = notes;
    
    // モーダルを表示
    new bootstrap.Modal(document.getElementById('editPartnerModal')).show();
}
</script>
{% endblock %}